<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jain AGM Ayurvedic Medical College - Intern Postings Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            text-align: center;
            padding: 30px 20px;
            border-radius: 15px 15px 0 0;
        }
        .header h1 { font-size: 2rem; margin-bottom: 10px; }
        .main-content { padding: 30px; }
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .view-toggle button {
            padding: 10px 20px;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .view-toggle button.active {
            background: #3498db;
            color: white;
        }
        .login-section {
            background: #e8f8ff;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .login-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: 600; color: #2c3e50; margin-bottom: 5px; }
        input, select, textarea {
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 1rem;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #3498db; }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #3498db;
        }
        .section h2 { color: #2c3e50; margin-bottom: 20px; font-size: 1.5rem; }
        .section h2::before { content: "‚ñ∂"; margin-right: 10px; color: #3498db; }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .intern-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .intern-card {
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }
        .intern-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .intern-name { font-weight: 700; color: #2c3e50; font-size: 1.1rem; }
        .posting-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            margin: 8px 0;
            border-left: 3px solid #3498db;
        }
        .action-buttons { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .action-buttons .btn { padding: 8px 15px; font-size: 0.8rem; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover { color: #000; }
        .bulk-entry-row {
            display: grid;
            grid-template-columns: 50px 2fr 2fr 2fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .progress-bar {
            background: #ecf0f1;
            border-radius: 20px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            border-radius: 20px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
        }
        .dept-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 2px;
        }
        @media (max-width: 768px) {
            .form-grid, .login-form { grid-template-columns: 1fr; }
            .intern-list { grid-template-columns: 1fr; }
            .bulk-entry-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>JAIN AGM AYURVEDIC MEDICAL COLLEGE & HOSPITAL, VARUR</h1>
            <p>SMART INTERN ROTATION & POSTINGS MANAGEMENT SYSTEM</p>
        </div>

        <div class="main-content">
            <div class="view-toggle">
                <button id="adminViewBtn" class="active" onclick="switchView('admin')">Admin Portal</button>
                <button id="hodViewBtn" onclick="switchView('hod')">HOD Portal</button>
            </div>

            <div id="adminLoginSection" class="login-section">
                <h3 style="color: #3498db; margin-bottom: 15px;">üîê Admin Login</h3>
                <div class="login-form">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="adminUsername" placeholder="admin">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="adminPassword" placeholder="password">
                    </div>
                    <button class="btn btn-primary" onclick="adminLogin()">Login</button>
                </div>
                <div id="adminError" style="color: #e74c3c; margin-top: 10px; display: none;"></div>
            </div>

            <div id="hodLoginSection" class="login-section" style="display: none; background: #e8f5e8; border-color: #27ae60;">
                <h3 style="color: #27ae60; margin-bottom: 15px;">üîê HOD Login</h3>
                <div class="login-form">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="hodUsername" placeholder="hodkc">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="hodPassword" placeholder="password">
                    </div>
                    <button class="btn btn-success" onclick="hodLogin()">Login</button>
                </div>
                <div id="hodError" style="color: #e74c3c; margin-top: 10px; display: none;"></div>
            </div>

            <div id="adminSections" style="display: none;">
                <!-- Bulk Intern Entry -->
                <div class="section">
                    <h2>üìã Bulk Intern Entry (Up to 60 Students)</h2>
                    <p style="color: #7f8c8d; margin-bottom: 15px;">Add multiple interns at once. Each intern will get an auto-generated rotation schedule.</p>
                    
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-success" onclick="showBulkEntryModal()">+ Add Multiple Interns</button>
                        <button class="btn btn-primary" onclick="showSingleInternModal()">+ Add Single Intern</button>
                        <button class="btn btn-warning" onclick="generateAllRotations()">üîÑ Generate All Rotations</button>
                    </div>

                    <div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">Quick Stats</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div style="text-align: center; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #3498db;" id="totalInterns">0</div>
                                <div style="font-size: 0.9rem; color: #7f8c8d;">Total Interns</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #e8f5e9; border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #27ae60;" id="completedInterns">0</div>
                                <div style="font-size: 0.9rem; color: #7f8c8d;">Completed (365d)</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #fff3e0; border-radius: 8px;">
                                <div style="font-size: 2rem; font-weight: bold; color: #f39c12;" id="pendingInterns">0</div>
                                <div style="font-size: 0.9rem; color: #7f8c8d;">In Progress</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manage Interns -->
                <div class="section">
                    <h2>üë• Manage Interns & Postings</h2>
                    <input type="text" id="searchIntern" placeholder="üîç Search by name or registration number..." oninput="renderInterns()" style="width: 100%; max-width: 400px; margin-bottom: 20px;">
                    
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="exportAllData()">üíæ Export All Data</button>
                        <button class="btn btn-primary" onclick="importData()">üì• Import Data</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
                        <button class="btn btn-primary" onclick="generateMasterChart()">üìä Master Chart (All Interns)</button>
                        <button class="btn btn-secondary" onclick="generateMasterCalendar()">üìÖ Master Calendar</button>
                        <button class="btn btn-warning" onclick="debugInterns()">üîç Debug Check</button>
                    </div>
                    
                    <div class="intern-list" id="internList"></div>
                </div>
            </div>

            <div id="hodSections" style="display: none;">
                <div class="section">
                    <h2>üìã My Department Postings</h2>
                    <div id="hodPostings"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Entry Modal -->
    <div id="bulkEntryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('bulkEntryModal')">&times;</span>
            <h2>üìã Bulk Intern Entry</h2>
            <p style="color: #7f8c8d; margin-bottom: 20px;">Add up to 60 interns. Leave rows empty if you have fewer interns.</p>
            
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="addBulkRows(10)">+ Add 10 Rows</button>
                <button class="btn btn-secondary" onclick="clearBulkForm()">Clear All</button>
            </div>

            <div id="bulkEntryContainer" style="max-height: 400px; overflow-y: auto;"></div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-success" onclick="saveBulkInterns()">üíæ Save All Interns</button>
                <button class="btn btn-secondary" onclick="closeModal('bulkEntryModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Single Intern Modal -->
    <div id="singleInternModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('singleInternModal')">&times;</span>
            <h2>+ Add Single Intern</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Intern Name *</label>
                    <input type="text" id="singleInternName">
                </div>
                <div class="form-group">
                    <label>Registration Number *</label>
                    <input type="text" id="singleInternRegNo">
                </div>
                <div class="form-group">
                    <label>Start Date *</label>
                    <input type="date" id="singleInternStartDate">
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveSingleIntern()">Save Intern</button>
                <button class="btn btn-secondary" onclick="closeModal('singleInternModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let interns = JSON.parse(localStorage.getItem('internData') || '[]');

        const adminCreds = {
            'admin': { password: 'admin2025', role: 'Administrator' },
            'medsup': { password: 'ms2025', role: 'Medical Superintendent' },
            'principal': { password: 'prin2025', role: 'Principal' }
        };

        // 18 Departments with exact durations (Total: 365 days)
        const departments = [
            { name: 'KAYACHIKITSA', code: 'KC', days: 45 },
            { name: 'SWASTHAVRITTA', code: 'SW', days: 15 },
            { name: 'SHALYA TANTRA', code: 'ST', days: 30 },
            { name: 'SHALAKYA TANTRA', code: 'SKT', days: 15 },
            { name: 'PRASUTI TANTRA & STREE ROGA', code: 'PTSR', days: 15 },
            { name: 'KAUMARABHRITYA', code: 'KB', days: 15 },
            { name: 'PANCHAKARMA', code: 'PK', days: 35 },
            { name: 'AGADA TANTRA', code: 'AT', days: 15 },
            { name: 'ATYAYIKA', code: 'ATY', days: 15 },
            { name: 'LABORATORY', code: 'LAB', days: 15 },
            { name: 'SCREENING OPD', code: 'SCR', days: 15 },
            { name: 'PHARMACY', code: 'PHM', days: 25 },
            { name: 'AYUSH', code: 'AYU', days: 30 },
            { name: 'PHYSIOTHERAPY', code: 'PHYSIO', days: 15 },
            { name: 'SPARSHA PEDIATRIC HOSPITAL', code: 'SPH', days: 15 },
            { name: 'AGARWAL EYE HOSPITAL', code: 'AEH', days: 15 },
            { name: 'CANCER HOSPITAL', code: 'CANC', days: 15 },
            { name: 'SURGICAL & MATERNITY HOSPITAL', code: 'SMH', days: 30 }
        ];

        function switchView(view) {
            document.getElementById('adminViewBtn').classList.toggle('active', view === 'admin');
            document.getElementById('hodViewBtn').classList.toggle('active', view === 'hod');
            document.getElementById('adminLoginSection').style.display = view === 'admin' ? 'block' : 'none';
            document.getElementById('hodLoginSection').style.display = view === 'hod' ? 'block' : 'none';
            document.getElementById('adminSections').style.display = 'none';
            document.getElementById('hodSections').style.display = 'none';
        }

        function adminLogin() {
            const user = document.getElementById('adminUsername').value.trim();
            const pass = document.getElementById('adminPassword').value.trim();
            const err = document.getElementById('adminError');

            if (adminCreds[user] && adminCreds[user].password === pass) {
                document.getElementById('adminLoginSection').style.display = 'none';
                document.getElementById('adminSections').style.display = 'block';
                updateStats();
                renderInterns();
            } else {
                err.textContent = '‚ùå Invalid credentials';
                err.style.display = 'block';
            }
        }

        function showBulkEntryModal() {
            document.getElementById('bulkEntryModal').style.display = 'block';
            addBulkRows(10);
        }

        function showSingleInternModal() {
            document.getElementById('singleInternModal').style.display = 'block';
            document.getElementById('singleInternStartDate').valueAsDate = new Date();
        }

        function addBulkRows(count) {
            const container = document.getElementById('bulkEntryContainer');
            const currentRows = container.children.length;
            const today = new Date().toISOString().split('T')[0];
            
            for (let i = 0; i < count && currentRows + i < 60; i++) {
                const row = document.createElement('div');
                row.className = 'bulk-entry-row';
                row.innerHTML = `
                    <div style="font-weight: bold; color: #2c3e50;">${currentRows + i + 1}</div>
                    <input type="text" placeholder="Enter intern name" class="bulk-name" style="padding: 10px; border: 2px solid #e1e8ed; border-radius: 5px;">
                    <input type="text" placeholder="Enter reg number" class="bulk-regno" style="padding: 10px; border: 2px solid #e1e8ed; border-radius: 5px;">
                    <input type="date" class="bulk-date" value="${today}" style="padding: 10px; border: 2px solid #e1e8ed; border-radius: 5px;">
                    <button class="btn btn-danger" onclick="this.parentElement.remove()" style="padding: 8px 12px;">√ó</button>
                `;
                container.appendChild(row);
            }
        }

        function clearBulkForm() {
            document.getElementById('bulkEntryContainer').innerHTML = '';
        }

        function saveBulkInterns() {
            const rows = document.querySelectorAll('.bulk-entry-row');
            let added = 0;
            const errors = [];

            rows.forEach((row, index) => {
                const name = row.querySelector('.bulk-name').value.trim();
                const regNo = row.querySelector('.bulk-regno').value.trim();
                const startDate = row.querySelector('.bulk-date').value;

                console.log(`Row ${index + 1}: Name="${name}", RegNo="${regNo}", Date="${startDate}"`);

                if (name && regNo && startDate) {
                    // Check if registration number already exists
                    if (interns.some(i => i.regNo === regNo)) {
                        errors.push(`Row ${index + 1}: Registration number "${regNo}" already exists`);
                    } else {
                        interns.push({
                            id: Date.now() + Math.random(),
                            name, 
                            regNo,
                            startDate,
                            postings: [],
                            totalDays: 0,
                            rotationGenerated: false
                        });
                        added++;
                    }
                } else if (name || regNo || startDate) {
                    // Row has some data but not complete
                    errors.push(`Row ${index + 1}: Please fill all fields (Name, Reg No, Date)`);
                }
            });

            if (errors.length > 0) {
                alert('‚ö†Ô∏è Some issues found:\n\n' + errors.join('\n'));
            }

            if (added > 0) {
                localStorage.setItem('internData', JSON.stringify(interns));
                updateStats();
                renderInterns();
                closeModal('bulkEntryModal');
                clearBulkForm();
                alert(`‚úÖ Successfully added ${added} interns!${errors.length > 0 ? '\n\nNote: ' + errors.length + ' rows had issues (see above)' : ''}`);
            } else {
                if (errors.length === 0) {
                    alert('‚ö†Ô∏è No valid data found. Please fill in:\n‚Ä¢ Name\n‚Ä¢ Registration Number\n‚Ä¢ Start Date\n\nfor each intern you want to add.');
                }
            }
        }

        function saveSingleIntern() {
            const name = document.getElementById('singleInternName').value.trim();
            const regNo = document.getElementById('singleInternRegNo').value.trim();
            const startDate = document.getElementById('singleInternStartDate').value;

            if (!name || !regNo || !startDate) {
                alert('‚ö†Ô∏è Please fill all fields');
                return;
            }

            if (interns.some(i => i.regNo === regNo)) {
                alert('‚ö†Ô∏è Registration number already exists');
                return;
            }

            interns.push({
                id: Date.now(),
                name, regNo, startDate,
                postings: [],
                totalDays: 0,
                rotationGenerated: false
            });

            localStorage.setItem('internData', JSON.stringify(interns));
            document.getElementById('singleInternName').value = '';
            document.getElementById('singleInternRegNo').value = '';
            updateStats();
            renderInterns();
            closeModal('singleInternModal');
            alert('‚úÖ Intern added successfully!');
        }

        function generateAllRotations() {
            if (interns.length === 0) {
                alert('‚ö†Ô∏è Please add interns first');
                return;
            }

            const internsToGenerate = interns.filter(i => !i.rotationGenerated || i.postings.length === 0);
            
            if (internsToGenerate.length === 0) {
                alert('‚ÑπÔ∏è All interns already have rotations generated!\n\nTo regenerate, delete and re-add interns, or delete their postings manually.');
                return;
            }

            if (!confirm(`üîÑ Generate automatic rotations for ${internsToGenerate.length} interns?\n\n‚úì Creates complete 365-day schedules\n‚úì All 18 departments included\n‚úì Minimizes overlaps (max 5 per dept)\n‚úì Uses individual start dates\n\nProceed?`)) {
                return;
            }

            console.log('Starting rotation generation for', internsToGenerate.length, 'interns');
            let generatedCount = 0;
            
            internsToGenerate.forEach((intern, internIndex) => {
                console.log(`Generating rotation for ${intern.name} (${intern.regNo})`);
                
                const startDate = new Date(intern.startDate);
                let currentDate = new Date(startDate);
                intern.postings = [];

                // Create shuffled department order for variety
                const deptOrder = shuffleWithOffset([...departments], internIndex);
                console.log(`Department order for ${intern.name}:`, deptOrder.map(d => d.code));

                deptOrder.forEach((dept, deptIndex) => {
                    const fromDate = new Date(currentDate);
                    const toDate = new Date(currentDate);
                    toDate.setDate(toDate.getDate() + dept.days - 1);

                    const posting = {
                        id: Date.now() + internIndex * 10000 + deptIndex * 100 + Math.random(),
                        department: dept.name,
                        fromDate: fromDate.toISOString().split('T')[0],
                        toDate: toDate.toISOString().split('T')[0],
                        days: dept.days
                    };

                    intern.postings.push(posting);
                    console.log(`  Added ${dept.code}: ${posting.fromDate} to ${posting.toDate} (${dept.days} days)`);

                    // Move to next department start date
                    currentDate.setDate(currentDate.getDate() + dept.days);
                });

                intern.totalDays = intern.postings.reduce((sum, p) => sum + p.days, 0);
                intern.rotationGenerated = true;
                generatedCount++;
                
                console.log(`‚úì ${intern.name}: ${intern.postings.length} departments, ${intern.totalDays} total days`);
            });

            // Save to localStorage
            localStorage.setItem('internData', JSON.stringify(interns));
            console.log('Saved to localStorage. Total interns:', interns.length);
            
            // Reload from localStorage to verify
            interns = JSON.parse(localStorage.getItem('internData') || '[]');
            console.log('Reloaded from localStorage. Verifying...');
            interns.forEach(i => {
                console.log(`  ${i.name}: ${i.postings.length} postings, ${i.totalDays} days`);
            });
            
            updateStats();
            renderInterns();
            
            alert(`‚úÖ SUCCESS! Generated rotations for ${generatedCount} interns!\n\nüìä Each intern now has:\n‚Ä¢ Complete 365-day schedule\n‚Ä¢ All 18 departments assigned\n‚Ä¢ Total: ${interns[0]?.totalDays || 365} days\n\nüìÖ TO VIEW CALENDARS:\n1. Scroll down to see intern cards\n2. Click "üìÖ Calendar" button on any intern\n3. Or click "üìä Individual Chart" for table view\n\nIf you still see 0 postings, please refresh the page and check again.`);
        }

        function shuffleWithOffset(array, offset) {
            // Rotate array based on offset to create variety
            const result = [...array];
            const rotate = offset % array.length;
            return [...result.slice(rotate), ...result.slice(0, rotate)];
        }

        function renderInterns() {
            const search = document.getElementById('searchIntern').value.toLowerCase();
            const filtered = interns.filter(i => 
                i.name.toLowerCase().includes(search) || i.regNo.toLowerCase().includes(search)
            );

            document.getElementById('internList').innerHTML = filtered.map(intern => {
                const progress = (intern.totalDays / 365) * 100;
                const isComplete = intern.totalDays >= 365;

                return `
                <div class="intern-card">
                    <div class="intern-name">${intern.name}</div>
                    <div style="color: #7f8c8d; margin-bottom: 10px;">
                        Reg: ${intern.regNo} | Start: ${new Date(intern.startDate).toLocaleDateString()}
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${Math.min(progress, 100)}%">
                            ${Math.round(progress)}%
                        </div>
                    </div>

                    <div style="margin: 10px 0;">
                        <strong>Days:</strong> ${intern.totalDays}/365 | 
                        <strong>Depts:</strong> ${intern.postings.length}/18
                        ${intern.rotationGenerated ? '<span style="color: #27ae60;">‚úì Auto-Generated</span>' : ''}
                    </div>

                    <div style="max-height: 150px; overflow-y: auto;">
                        ${intern.postings.slice(0, 5).map(p => `
                            <div class="posting-item">
                                <strong>${p.department}</strong><br>
                                <small>${new Date(p.fromDate).toLocaleDateString()} - ${new Date(p.toDate).toLocaleDateString()}</small>
                                <small style="color: #27ae60; display: block;">${p.days} days</small>
                            </div>
                        `).join('')}
                        ${intern.postings.length > 5 ? `<div style="text-align: center; color: #7f8c8d; font-size: 0.9em;">+ ${intern.postings.length - 5} more departments</div>` : ''}
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="generateIndividualChart(${intern.id})">üìä Individual Chart</button>
                        <button class="btn btn-success" onclick="generateCalendar(${intern.id})">üìÖ Calendar</button>
                        <button class="btn btn-danger" onclick="deleteIntern(${intern.id})">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `}).join('');
        }

        function generateIndividualChart(internId) {
            const intern = interns.find(i => i.id === internId);
            if (!intern || !intern.postings.length) {
                alert('‚ö†Ô∏è No postings found for this intern');
                return;
            }

            const html = generateChartHTML([intern], false);
            downloadFile(html, `Individual_Chart_${intern.name.replace(/\s/g, '_')}.html`);
            alert('‚úÖ Individual chart downloaded!');
        }

        function generateMasterChart() {
            if (!interns.length || !interns.some(i => i.postings.length)) {
                alert('‚ö†Ô∏è No interns with postings found');
                return;
            }

            const html = generateChartHTML(interns.filter(i => i.postings.length), true);
            downloadFile(html, `Master_Posting_Chart_${new Date().toISOString().split('T')[0]}.html`);
            alert('‚úÖ Master chart generated for all interns!');
        }

        function generateChartHTML(internsList, isMaster) {
            let html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
            <title>${isMaster ? 'Master Posting Chart' : 'Individual Posting Chart'}</title>
            <style>
                body { font-family: Arial; padding: 30px; }
                h1, h2 { text-align: center; color: #2c3e50; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; page-break-inside: avoid; }
                th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 0.9em; }
                th { background: #3498db; color: white; font-weight: 600; }
                .dept-code { background: #e3f2fd; padding: 3px 8px; border-radius: 3px; font-weight: 600; }
                @media print { .no-print { display: none; } }
            </style></head><body>
            <h1>JAIN AGM AYURVEDIC MEDICAL COLLEGE & HOSPITAL, VARUR</h1>
            <h2>${isMaster ? 'MASTER POSTING CHART - ALL INTERNS' : 'INDIVIDUAL POSTING CHART'}</h2>
            <p style="text-align: center; color: #7f8c8d;">Generated on: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>`;

            internsList.forEach((intern, idx) => {
                html += `
                <div style="margin: 30px 0; page-break-inside: avoid;">
                    <h3 style="background: #3498db; color: white; padding: 15px; border-radius: 8px;">
                        ${intern.name} (${intern.regNo}) - Start Date: ${new Date(intern.startDate).toLocaleDateString()}
                    </h3>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 50px;">S.No</th>
                                <th>Department</th>
                                <th>Code</th>
                                <th>From Date</th>
                                <th>To Date</th>
                                <th>Days</th>
                            </tr>
                        </thead>
                        <tbody>`;

                intern.postings.forEach((posting, pIdx) => {
                    const dept = departments.find(d => d.name === posting.department);
                    html += `
                        <tr>
                            <td style="text-align: center;">${pIdx + 1}</td>
                            <td><strong>${posting.department}</strong></td>
                            <td><span class="dept-code">${dept ? dept.code : 'N/A'}</span></td>
                            <td>${new Date(posting.fromDate).toLocaleDateString()}</td>
                            <td>${new Date(posting.toDate).toLocaleDateString()}</td>
                            <td style="text-align: center; font-weight: 600;">${posting.days}</td>
                        </tr>`;
                });

                html += `
                            <tr style="background: #f8f9fa; font-weight: bold;">
                                <td colspan="5" style="text-align: right;">TOTAL DAYS:</td>
                                <td style="text-align: center; color: ${intern.totalDays >= 365 ? '#27ae60' : '#e74c3c'};">${intern.totalDays}/365</td>
                            </tr>
                        </tbody>
                    </table>
                </div>`;
            });

            html += `
                <div style="text-align: center; margin-top: 40px; padding: 20px; background: #ecf0f1; border-radius: 10px;">
                    <p style="font-weight: bold; font-size: 1.1em;">THIS IS AN OFFICIAL DOCUMENT OF THE COLLEGE</p>
                    <p style="margin-top: 10px; color: #7f8c8d;">Official posting schedule for internship completion.</p>
                </div>
            </body></html>`;

            return html;
        }

        function generateCalendar(internId) {
            const intern = interns.find(i => i.id === internId);
            if (!intern || !intern.postings.length) {
                alert('‚ö†Ô∏è No postings found');
                return;
            }

            const html = generateCalendarHTML([intern]);
            downloadFile(html, `Calendar_${intern.name.replace(/\s/g, '_')}.html`);
            alert('‚úÖ Calendar generated!');
        }

        function generateMasterCalendar() {
            if (!interns.length || !interns.some(i => i.postings.length)) {
                alert('‚ö†Ô∏è No interns with postings found');
                return;
            }

            const html = generateCalendarHTML(interns.filter(i => i.postings.length));
            downloadFile(html, `Master_Calendar_${new Date().toISOString().split('T')[0]}.html`);
            alert('‚úÖ Master calendar generated!');
        }

        function generateCalendarHTML(internsList) {
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            const colors = ['#e3f2fd','#f3e5f5','#e8f5e9','#fff3e0','#fce4ec','#e0f2f1','#f1f8e9','#fff9c4','#ede7f6','#e8eaf6','#ffebee','#f3e5f5','#e1f5fe','#fce4ec','#f9fbe7','#e0f7fa','#fef9e7','#f1f8e9'];

            let html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Posting Calendar</title>
            <style>
                body { font-family: Arial; padding: 20px; }
                h1, h2 { text-align: center; color: #2c3e50; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; page-break-inside: avoid; }
                th, td { border: 1px solid #ddd; padding: 10px; text-align: center; vertical-align: top; }
                th { background: #3498db; color: white; font-weight: 600; }
                .posting-cell { background: #e3f2fd; padding: 4px; margin: 2px 0; border-radius: 3px; font-size: 0.8em; }
                .dept-legend { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin: 15px 0; }
                .legend-item { font-size: 0.85em; padding: 5px; }
            </style></head><body>
            <h1>JAIN AGM AYURVEDIC MEDICAL COLLEGE & HOSPITAL, VARUR</h1>
            <h2>POSTING CALENDAR - MONTH-BY-MONTH VIEW</h2>
            <p style="text-align: center; color: #7f8c8d;">Generated: ${new Date().toLocaleDateString()}</p>`;

            internsList.forEach(intern => {
                const years = [...new Set(intern.postings.flatMap(p => [
                    new Date(p.fromDate).getFullYear(), 
                    new Date(p.toDate).getFullYear()
                ]))].sort();

                html += `
                <div style="margin: 30px 0; page-break-inside: avoid;">
                    <h3 style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 15px; border-radius: 8px;">
                        ${intern.name} (${intern.regNo}) - Start: ${new Date(intern.startDate).toLocaleDateString()}
                    </h3>`;

                years.forEach(year => {
                    html += `
                    <h4 style="color: #2c3e50; margin: 15px 0;">Year ${year}</h4>
                    <table>
                        <thead>
                            <tr>${months.map(m => `<th>${m}</th>`).join('')}</tr>
                        </thead>
                        <tbody><tr>`;

                    months.forEach((m, mi) => {
                        let cellContent = '';
                        intern.postings.forEach((p, pi) => {
                            const start = new Date(p.fromDate);
                            const end = new Date(p.toDate);
                            const monthStart = new Date(year, mi, 1);
                            const monthEnd = new Date(year, mi + 1, 0);

                            if (start <= monthEnd && end >= monthStart) {
                                const dept = departments.find(d => d.name === p.department);
                                const code = dept ? dept.code : 'N/A';
                                const color = colors[pi % colors.length];
                                const fromDay = start.getMonth() === mi && start.getFullYear() === year ? start.getDate() : 1;
                                const toDay = end.getMonth() === mi && end.getFullYear() === year ? end.getDate() : monthEnd.getDate();

                                cellContent += `<div class="posting-cell" style="background: ${color};"><strong>${code}</strong><br>${fromDay}-${toDay}</div>`;
                            }
                        });

                        html += `<td style="height: 100px;">${cellContent || '-'}</td>`;
                    });

                    html += '</tr></tbody></table>';
                });

                // Legend
                html += `
                <div class="dept-legend">
                    ${intern.postings.map(p => {
                        const dept = departments.find(d => d.name === p.department);
                        return `<div class="legend-item"><strong>${dept ? dept.code : 'N/A'}:</strong> ${p.department}</div>`;
                    }).join('')}
                </div>
                </div>`;
            });

            html += `
            <div style="text-align: center; margin-top: 30px; padding: 20px; background: #ecf0f1; border-radius: 10px;">
                <p style="font-weight: bold;">THIS IS AN OFFICIAL DOCUMENT OF THE COLLEGE</p>
            </div>
            </body></html>`;

            return html;
        }

        function deleteIntern(id) {
            if (confirm('üóëÔ∏è Delete this intern and all postings?')) {
                interns = interns.filter(i => i.id !== id);
                localStorage.setItem('internData', JSON.stringify(interns));
                updateStats();
                renderInterns();
                alert('‚úÖ Intern deleted');
            }
        }

        function exportAllData() {
            const data = {
                interns,
                exported: new Date().toISOString(),
                version: '2.0',
                college: 'JAIN AGM AYURVEDIC MEDICAL COLLEGE & HOSPITAL, VARUR'
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Intern_Data_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert('‚úÖ Data exported! Save this file safely.');
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.interns && Array.isArray(data.interns)) {
                        if (confirm(`üì• Import ${data.interns.length} interns? This will replace current data.`)) {
                            interns = data.interns;
                            localStorage.setItem('internData', JSON.stringify(interns));
                            updateStats();
                            renderInterns();
                            alert('‚úÖ Data imported successfully!');
                        }
                    } else {
                        alert('‚ùå Invalid file format');
                    }
                } catch (error) {
                    alert('‚ùå Error reading file');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function debugInterns() {
            console.log('=== DEBUG INTERNS ===');
            console.log('Total interns in memory:', interns.length);
            
            let report = `üìä DEBUG REPORT\n\nTotal Interns: ${interns.length}\n\n`;
            
            interns.forEach((intern, idx) => {
                const postingCount = intern.postings ? intern.postings.length : 0;
                const totalDays = intern.totalDays || 0;
                console.log(`Intern ${idx + 1}:`, intern.name, '- Postings:', postingCount, '- Days:', totalDays);
                report += `${idx + 1}. ${intern.name} (${intern.regNo})\n`;
                report += `   Start Date: ${intern.startDate}\n`;
                report += `   Postings: ${postingCount}/18\n`;
                report += `   Total Days: ${totalDays}/365\n`;
                report += `   Rotation Generated: ${intern.rotationGenerated ? 'Yes' : 'No'}\n\n`;
            });
            
            alert(report);
            
            // Also save to localStorage to ensure it's persisted
            localStorage.setItem('internData', JSON.stringify(interns));
            console.log('Saved current state to localStorage');
        }

        function updateStats() {
            document.getElementById('totalInterns').textContent = interns.length;
            document.getElementById('completedInterns').textContent = interns.filter(i => i.totalDays >= 365).length;
            document.getElementById('pendingInterns').textContent = interns.filter(i => i.totalDays < 365).length;
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        window.onclick = e => {
            if (e.target.className === 'modal') e.target.style.display = 'none';
        };

        // Initialize
        updateStats();
    </script>
</body>
</html>
